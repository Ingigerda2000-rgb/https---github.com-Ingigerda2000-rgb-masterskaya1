{% extends 'base.html' %}
{% load static %}

{% block title %}Низкий запас материалов :: HandMadeShop{% endblock %}

{% block extra_css %}
<style>
.alert-card {
    border-left: 4px solid;
    transition: all 0.3s ease;
}

.alert-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.alert-critical {
    border-left-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.05);
}

.alert-warning {
    border-left-color: #ffc107;
    background-color: rgba(255, 193, 7, 0.05);
}

.alert-info {
    border-left-color: #0dcaf0;
    background-color: rgba(13, 202, 240, 0.05);
}

.urgency-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.action-buttons {
    min-width: 200px;
}

.progress-thin {
    height: 4px;
}

@media (max-width: 768px) {
    .mobile-stats {
        flex-wrap: wrap;
    }
    
    .mobile-stat-card {
        flex: 0 0 calc(50% - 0.5rem);
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Заголовок -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">
                <i class="bi bi-exclamation-triangle text-warning me-2"></i>Низкий запас материалов
            </h1>
            <p class="text-muted mb-0">Материалы, требующие пополнения</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'materials:material_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Все материалы
            </a>
            <button type="button" class="btn btn-primary" onclick="printReport()">
                <i class="bi bi-printer me-1"></i>Печать отчёта
            </button>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4 mobile-stats">
        <div class="col-md-3 mobile-stat-card">
            <div class="card border-start border-danger border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Закончились</h6>
                            <h3 class="mb-0">{{ total_out_of_stock }}</h3>
                        </div>
                        <div class="avatar avatar-sm bg-danger bg-opacity-10 p-2 rounded">
                            <i class="bi bi-x-circle fs-4 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mobile-stat-card">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Низкий запас</h6>
                            <h3 class="mb-0">{{ total_low_stock }}</h3>
                        </div>
                        <div class="avatar avatar-sm bg-warning bg-opacity-10 p-2 rounded">
                            <i class="bi bi-exclamation-triangle fs-4 text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mobile-stat-card">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Всего на контроле</h6>
                            <h3 class="mb-0">{{ total_low_stock|add:total_out_of_stock }}</h3>
                        </div>
                        <div class="avatar avatar-sm bg-primary bg-opacity-10 p-2 rounded">
                            <i class="bi bi-clipboard-check fs-4 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mobile-stat-card">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Рекомендуемый заказ</h6>
                            <h3 class="mb-0" id="totalReorderCost">0 ₽</h3>
                        </div>
                        <div class="avatar avatar-sm bg-success bg-opacity-10 p-2 rounded">
                            <i class="bi bi-cart-plus fs-4 text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Приоритет</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="priorityFilter" id="priorityAll" checked>
                        <label class="btn btn-outline-primary" for="priorityAll">Все</label>
                        
                        <input type="radio" class="btn-check" name="priorityFilter" id="priorityCritical">
                        <label class="btn btn-outline-danger" for="priorityCritical">
                            <i class="bi bi-x-circle me-1"></i>Закончились
                        </label>
                        
                        <input type="radio" class="btn-check" name="priorityFilter" id="priorityWarning">
                        <label class="btn btn-outline-warning" for="priorityWarning">
                            <i class="bi bi-exclamation-triangle me-1"></i>Низкий запас
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Поставщик</label>
                    <select class="form-select" id="supplierFilter">
                        <option value="">Все поставщики</option>
                        {% for supplier in suppliers %}
                        <option value="{{ supplier }}">{{ supplier }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Сбросить фильтры
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Закончившиеся материалы (Критические) -->
    {% if out_of_stock %}
    <div class="card mb-4">
        <div class="card-header bg-danger bg-opacity-10 border-danger">
            <h5 class="mb-0">
                <i class="bi bi-x-circle text-danger me-2"></i>
                Критически низкий запас (закончились)
                <span class="badge bg-danger ms-2">{{ out_of_stock.count }}</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="25%">Материал</th>
                            <th width="15%">Текущий остаток</th>
                            <th width="15%">Минимум</th>
                            <th width="20%">Поставщик</th>
                            <th width="25%">Рекомендуемые действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in out_of_stock %}
                        <tr class="alert-card alert-critical">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar avatar-sm bg-danger bg-opacity-10 text-danger rounded-circle">
                                            <i class="bi bi-box"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">{{ material.name }}</h6>
                                        {% if material.color %}
                                        <small class="text-muted">
                                            <i class="bi bi-palette me-1"></i>{{ material.color }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold text-danger">0 {{ material.get_unit_display }}</div>
                                <small class="text-muted">Нет в наличии</small>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark border">{{ material.min_quantity|floatformat:3 }}</span>
                            </td>
                            <td>
                                {% if material.supplier %}
                                <div>{{ material.supplier }}</div>
                                <small class="text-muted">{{ material.supplier_contact|default:"Контакты не указаны" }}</small>
                                {% else %}
                                <span class="text-muted">Не указан</span>
                                {% endif %}
                            </td>
                            <td class="action-buttons">
                                <div class="btn-group btn-group-sm w-100">
                                    <button type="button" class="btn btn-outline-primary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#updateQuantityModal"
                                            data-material-id="{{ material.id }}"
                                            data-material-name="{{ material.name }}"
                                            data-current-quantity="0">
                                        <i class="bi bi-plus-circle"></i> Пополнить
                                    </button>
                                    <a href="{% url 'materials:material_update' material.id %}" 
                                       class="btn btn-outline-secondary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% if material.supplier_contact %}
                                    <a href="#" class="btn btn-outline-success" 
                                       onclick="contactSupplier('{{ material.supplier }}', '{{ material.supplier_contact }}', '{{ material.name }}')">
                                        <i class="bi bi-telephone"></i>
                                    </a>
                                    {% endif %}
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Рекомендуемый заказ: 
                                        <span class="fw-bold">{{ material.min_quantity|floatformat:3 }} {{ material.get_unit_display }}</span>
                                    </small>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Итоги по критическим материалам -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">Общая стоимость пополнения:</small>
                            <div class="fw-bold" id="criticalReorderCost">
                                {% with total=0 %}
                                {% for material in out_of_stock %}
                                {% widthratio material.min_quantity 1 material.price_per_unit as cost %}
                                {% with total=total|add:cost %}
                                {% endwith %}
                                {% endfor %}
                                {{ total|floatformat:2 }} ₽
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">Всего позиций:</small>
                            <div class="fw-bold">{{ out_of_stock.count }}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">Поставщиков:</small>
                            <div class="fw-bold">{{ unique_suppliers_critical }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Низкий запас (Предупреждение) -->
    {% if low_stock %}
    <div class="card">
        <div class="card-header bg-warning bg-opacity-10 border-warning">
            <h5 class="mb-0">
                <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                Низкий запас (требует внимания)
                <span class="badge bg-warning ms-2">{{ low_stock.count }}</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="25%">Материал</th>
                            <th width="15%">Текущий остаток</th>
                            <th width="15%">Минимум</th>
                            <th width="15%">Запас, %</th>
                            <th width="15%">Поставщик</th>
                            <th width="15%">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for material in low_stock %}
                        {% with percent=material.current_quantity|floatformat:2|add:"0" min_percent=material.min_quantity|floatformat:2|add:"0" %}
                        {% widthratio material.current_quantity material.min_quantity 100 as stock_percent %}
                        <tr class="alert-card alert-warning">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar avatar-sm bg-warning bg-opacity-10 text-warning rounded-circle">
                                            <i class="bi bi-box"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">{{ material.name }}</h6>
                                        {% if material.color %}
                                        <small class="text-muted">
                                            <i class="bi bi-palette me-1"></i>{{ material.color }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold text-warning">{{ material.current_quantity|floatformat:3 }}</div>
                                <small class="text-muted">{{ material.get_unit_display }}</small>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark border">{{ material.min_quantity|floatformat:3 }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1 me-2">
                                        <div class="progress progress-thin">
                                            <div class="progress-bar {% if stock_percent < 25 %}bg-danger{% elif stock_percent < 50 %}bg-warning{% else %}bg-info{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ stock_percent }}%">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <small class="fw-bold">{{ stock_percent|floatformat:0 }}%</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if material.supplier %}
                                <div>{{ material.supplier|truncatechars:15 }}</div>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#updateQuantityModal"
                                            data-material-id="{{ material.id }}"
                                            data-material-name="{{ material.name }}"
                                            data-current-quantity="{{ material.current_quantity }}">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                    <a href="{% url 'materials:material_update' material.id %}" 
                                       class="btn btn-outline-secondary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Итоги по материалам с низким запасом -->
            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">Средний запас:</small>
                            <div class="fw-bold" id="avgStockPercent">
                                {% if low_stock %}
                                {% with total_percent=0 %}
                                {% for material in low_stock %}
                                {% widthratio material.current_quantity material.min_quantity 100 as percent %}
                                {% with total_percent=total_percent|add:percent %}
                                {% endwith %}
                                {% endfor %}
                                {{ total_percent|divisibleby:low_stock.count|floatformat:1 }}%
                                {% endwith %}
                                {% else %}0%{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">Менее 25% запаса:</small>
                            <div class="fw-bold text-danger" id="criticalStockCount">
                                {% with count=0 %}
                                {% for material in low_stock %}
                                {% widthratio material.current_quantity material.min_quantity 100 as percent %}
                                {% if percent < 25 %}{% with count=count|add:1 %}{% endwith %}{% endif %}
                                {% endfor %}
                                {{ count }}
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">Менее 50% запаса:</small>
                            <div class="fw-bold text-warning" id="warningStockCount">
                                {% with count=0 %}
                                {% for material in low_stock %}
                                {% widthratio material.current_quantity material.min_quantity 100 as percent %}
                                {% if percent >= 25 and percent < 50 %}{% with count=count|add:1 %}{% endwith %}{% endif %}
                                {% endfor %}
                                {{ count }}
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small class="text-muted">Рекомендуемый заказ:</small>
                            <div class="fw-bold" id="warningReorderCost">
                                {% with total=0 %}
                                {% for material in low_stock %}
                                {% widthratio material.min_quantity|multiply:2 material.current_quantity|subtract 1 material.price_per_unit as cost %}
                                {% with total=total|add:cost %}
                                {% endwith %}
                                {% endfor %}
                                {{ total|floatformat:2 }} ₽
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Если нет материалов с низким запасом -->
    {% if not out_of_stock and not low_stock %}
    <div class="card">
        <div class="card-body">
            <div class="text-center py-5">
                <div class="avatar avatar-xl bg-success bg-opacity-10 text-success rounded-circle mb-3 d-inline-flex align-items-center justify-content-center">
                    <i class="bi bi-check-circle fs-1"></i>
                </div>
                <h4 class="mb-3">Отличная работа!</h4>
                <p class="text-muted mb-4">
                    Все материалы в норме. Нет позиций с низким запасом или закончившихся.
                </p>
                <div class="alert alert-success d-inline-block">
                    <i class="bi bi-trophy me-2"></i>
                    Ваши запасы хорошо управляются. Продолжайте в том же духе!
                </div>
                <div class="mt-4">
                    <a href="{% url 'materials:material_list' %}" class="btn btn-primary">
                        <i class="bi bi-box-seam me-1"></i>Перейти ко всем материалам
                    </a>
                    <a href="{% url 'materials:report' %}" class="btn btn-outline-primary">
                        <i class="bi bi-graph-up me-1"></i>Посмотреть отчёт
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Рекомендации по закупкам -->
    {% if out_of_stock or low_stock %}
    <div class="card mt-4">
        <div class="card-header bg-info bg-opacity-10 border-info">
            <h5 class="mb-0">
                <i class="bi bi-cart-plus text-info me-2"></i>
                Рекомендации по закупкам
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h6>План действий:</h6>
                    <ol class="mb-0">
                        {% if out_of_stock %}
                        <li class="mb-2">
                            <strong>Срочно заказать материалы, которые закончились:</strong>
                            <ul class="mt-1">
                                {% for material in out_of_stock|slice:":3" %}
                                <li>{{ material.name }} ({{ material.min_quantity }} {{ material.get_unit_display }})</li>
                                {% endfor %}
                                {% if out_of_stock.count > 3 %}
                                <li>... и ещё {{ out_of_stock.count|add:"-3" }} позиций</li>
                                {% endif %}
                            </ul>
                        </li>
                        {% endif %}
                        {% if low_stock %}
                        <li class="mb-2">
                            <strong>Запланировать закупку материалов с низким запасом:</strong>
                            <ul class="mt-1">
                                {% for material in low_stock|slice:":3" %}
                                {% widthratio material.current_quantity material.min_quantity 100 as percent %}
                                {% if percent < 50 %}
                                <li>{{ material.name }} (осталось {{ percent|floatformat:0 }}%)</li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </li>
                        {% endif %}
                        <li>
                            <strong>Связаться с поставщиками:</strong>
                            <ul class="mt-1">
                                {% for supplier in unique_suppliers %}
                                <li>{{ supplier }}</li>
                                {% endfor %}
                            </ul>
                        </li>
                    </ol>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6>Итоговые цифры:</h6>
                            <div class="mb-2">
                                <small class="text-muted">Всего позиций для заказа:</small>
                                <div class="fw-bold">{{ total_low_stock|add:total_out_of_stock }}</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Примерная стоимость:</small>
                                <div class="fw-bold h5" id="totalOrderCost">0 ₽</div>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Приоритетных поставщиков:</small>
                                <div class="fw-bold">{{ unique_suppliers|length }}</div>
                            </div>
                            <button type="button" class="btn btn-primary w-100" onclick="generateOrderList()">
                                <i class="bi bi-file-earmark-text me-1"></i>Создать список заказа
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Модальное окно обновления количества -->
<div class="modal fade" id="updateQuantityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Пополнение материала</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Содержимое загружается динамически -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно списка заказа -->
<div class="modal fade" id="orderListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Список для заказа</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Содержимое генерируется динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="printOrderList()">
                    <i class="bi bi-printer me-1"></i>Печать
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Данные о материалах для расчётов
var materialsData = {
    critical: [
        {% for material in out_of_stock %}
        {
            id: '{{ material.id }}',
            name: '{{ material.name }}',
            current: {{ material.current_quantity|default:0 }},
            min: {{ material.min_quantity|default:0 }},
            unit: '{{ material.get_unit_display }}',
            price: {{ material.price_per_unit|default:0 }},
            supplier: '{{ material.supplier|default:"" }}',
            contact: '{{ material.supplier_contact|default:"" }}'
        },
        {% endfor %}
    ],
    warning: [
        {% for material in low_stock %}
        {
            id: '{{ material.id }}',
            name: '{{ material.name }}',
            current: {{ material.current_quantity|default:0 }},
            min: {{ material.min_quantity|default:0 }},
            unit: '{{ material.get_unit_display }}',
            price: {{ material.price_per_unit|default:0 }},
            supplier: '{{ material.supplier|default:"" }}',
            contact: '{{ material.supplier_contact|default:"" }}'
        },
        {% endfor %}
    ]
};

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    // Рассчитываем общую стоимость заказа
    calculateTotalCosts();
    
    // Настраиваем фильтры
    setupFilters();
    
    // Настраиваем модальные окна
    setupModals();
});

// Рассчёт общей стоимости
function calculateTotalCosts() {
    var totalCost = 0;
    var criticalCost = 0;
    var warningCost = 0;
    
    // Критические материалы (закончились)
    materialsData.critical.forEach(function(material) {
        var recommended = Math.max(material.min, material.min * 2); // Рекомендуем в 2 раза больше минимума
        var cost = recommended * material.price;
        criticalCost += cost;
        totalCost += cost;
    });
    
    // Материалы с низким запасом
    materialsData.warning.forEach(function(material) {
        var recommended = Math.max(material.min * 2 - material.current, material.min * 0.5);
        var cost = recommended * material.price;
        warningCost += cost;
        totalCost += cost;
    });
    
    // Обновляем отображение
    document.getElementById('criticalReorderCost').textContent = criticalCost.toFixed(2) + ' ₽';
    document.getElementById('warningReorderCost').textContent = warningCost.toFixed(2) + ' ₽';
    document.getElementById('totalReorderCost').textContent = totalCost.toFixed(2) + ' ₽';
    document.getElementById('totalOrderCost').textContent = totalCost.toFixed(2) + ' ₽';
}

// Настройка фильтров
function setupFilters() {
    // Фильтр по приоритету
    var priorityFilters = document.querySelectorAll('input[name="priorityFilter"]');
    priorityFilters.forEach(function(filter) {
        filter.addEventListener('change', function() {
            applyFilters();
        });
    });
    
    // Фильтр по поставщику
    var supplierFilter = document.getElementById('supplierFilter');
    if (supplierFilter) {
        supplierFilter.addEventListener('change', applyFilters);
    }
}

// Применение фильтров
function applyFilters() {
    var selectedPriority = document.querySelector('input[name="priorityFilter"]:checked').id;
    var selectedSupplier = document.getElementById('supplierFilter').value;
    
    // Показываем/скрываем строки таблицы
    var rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(function(row) {
        var showRow = true;
        
        // Фильтр по приоритету
        if (selectedPriority === 'priorityCritical') {
            if (!row.classList.contains('alert-critical')) {
                showRow = false;
            }
        } else if (selectedPriority === 'priorityWarning') {
            if (!row.classList.contains('alert-warning')) {
                showRow = false;
            }
        }
        
        // Фильтр по поставщику
        if (showRow && selectedSupplier) {
            var supplierCell = row.querySelector('td:nth-child(4)');
            if (supplierCell) {
                var supplierText = supplierCell.textContent.trim();
                if (!supplierText.includes(selectedSupplier)) {
                    showRow = false;
                }
            }
        }
        
        // Применяем видимость
        if (showRow) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Сброс фильтров
function resetFilters() {
    document.getElementById('priorityAll').checked = true;
    document.getElementById('supplierFilter').value = '';
    applyFilters();
}

// Контакт с поставщиком
function contactSupplier(supplier, contact, material) {
    var message = `Здравствуйте!\n\nТребуется поставка материала:\n\n` +
                  `Материал: ${material}\n` +
                  `Поставщик: ${supplier}\n` +
                  `Контакт: ${contact}\n\n` +
                  `Пожалуйста, свяжитесь для обсуждения условий поставки.`;
    
    if (contact.includes('@')) {
        // Email
        window.location.href = `mailto:${contact}?subject=Запрос на поставку материала&body=${encodeURIComponent(message)}`;
    } else if (contact.replace(/\D/g, '').length >= 10) {
        // Телефон
        var phone = contact.replace(/\D/g, '');
        window.location.href = `tel:${phone}`;
    } else {
        // Показываем сообщение
        alert(`Контактная информация поставщика "${supplier}":\n\n${contact}\n\n${message}`);
    }
}

// Генерация списка для заказа
function generateOrderList() {
    var modalContent = document.querySelector('#orderListModal .modal-body');
    var html = `
        <div class="order-list-header mb-4">
            <h6>Список материалов для заказа</h6>
            <p class="text-muted">Сгенерировано: ${new Date().toLocaleDateString('ru-RU')}</p>
        </div>
        
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>№</th>
                        <th>Материал</th>
                        <th>Текущий остаток</th>
                        <th>Минимум</th>
                        <th>Рекомендуемый заказ</th>
                        <th>Ед. изм.</th>
                        <th>Цена за ед.</th>
                        <th>Стоимость</th>
                        <th>Поставщик</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    var totalCost = 0;
    var index = 1;
    
    // Критические материалы
    if (materialsData.critical.length > 0) {
        html += `
            <tr class="table-danger">
                <td colspan="9" class="fw-bold">
                    <i class="bi bi-x-circle me-1"></i>Критические (закончились)
                </td>
            </tr>
        `;
        
        materialsData.critical.forEach(function(material) {
            var recommended = Math.max(material.min, material.min * 2);
            var cost = recommended * material.price;
            totalCost += cost;
            
            html += `
                <tr>
                    <td>${index++}</td>
                    <td>${material.name}</td>
                    <td class="text-danger">0</td>
                    <td>${material.min}</td>
                    <td class="fw-bold">${recommended.toFixed(3)}</td>
                    <td>${material.unit}</td>
                    <td>${material.price.toFixed(2)} ₽</td>
                    <td>${cost.toFixed(2)} ₽</td>
                    <td>${material.supplier || '—'}</td>
                </tr>
            `;
        });
    }
    
    // Материалы с низким запасом
    if (materialsData.warning.length > 0) {
        html += `
            <tr class="table-warning">
                <td colspan="9" class="fw-bold">
                    <i class="bi bi-exclamation-triangle me-1"></i>Низкий запас
                </td>
            </tr>
        `;
        
        materialsData.warning.forEach(function(material) {
            var recommended = Math.max(material.min * 2 - material.current, material.min * 0.5);
            var cost = recommended * material.price;
            totalCost += cost;
            
            html += `
                <tr>
                    <td>${index++}</td>
                    <td>${material.name}</td>
                    <td>${material.current}</td>
                    <td>${material.min}</td>
                    <td class="fw-bold">${recommended.toFixed(3)}</td>
                    <td>${material.unit}</td>
                    <td>${material.price.toFixed(2)} ₽</td>
                    <td>${cost.toFixed(2)} ₽</td>
                    <td>${material.supplier || '—'}</td>
                </tr>
            `;
        });
    }
    
    html += `
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="7" class="text-end fw-bold">Итого:</td>
                        <td class="fw-bold">${totalCost.toFixed(2)} ₽</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="mt-4">
            <h6>Инструкция:</h6>
            <ol class="small">
                <li>Свяжитесь с поставщиками в порядке приоритета</li>
                <li>Уточните сроки поставки и наличие материалов</li>
                <li>Согласуйте цены и условия оплаты</li>
                <li>После получения обновите остатки в системе</li>
            </ol>
        </div>
    `;
    
    modalContent.innerHTML = html;
    
    var modal = new bootstrap.Modal(document.getElementById('orderListModal'));
    modal.show();
}

// Печать отчёта
function printReport() {
    window.print();
}

// Печать списка заказа
function printOrderList() {
    var printContent = document.querySelector('#orderListModal .modal-body').innerHTML;
    var printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Список для заказа материалов</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f5f5f5; }
                    .total-row { font-weight: bold; background-color: #f8f9fa; }
                    .header { text-align: center; margin-bottom: 30px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h2>Список материалов для заказа</h2>
                    <p>Дата: ${new Date().toLocaleDateString('ru-RU')}</p>
                </div>
                ${printContent}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Настройка модальных окон
function setupModals() {
    var updateModal = document.getElementById('updateQuantityModal');
    if (updateModal) {
        updateModal.addEventListener('show.bs.modal', function(event) {
            var button = event.relatedTarget;
            var materialId = button.getAttribute('data-material-id');
            var materialName = button.getAttribute('data-material-name');
            var currentQuantity = button.getAttribute('data-current-quantity');
            
            var modalBody = updateModal.querySelector('.modal-body');
            modalBody.innerHTML = `
                <form id="quickUpdateForm">
                    <input type="hidden" name="material_id" value="${materialId}">
                    <div class="mb-3">
                        <label class="form-label">Материал</label>
                        <input type="text" class="form-control" value="${materialName}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Текущее количество</label>
                        <input type="text" class="form-control" value="${currentQuantity}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Количество для добавления</label>
                        <input type="number" name="quantity" class="form-control" 
                               step="0.001" min="0.001" required 
                               placeholder="Введите количество">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Примечание (необязательно)</label>
                        <textarea name="notes" class="form-control" rows="2" 
                                  placeholder="Например: Закупка у поставщика..."></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        После сохранения количество будет увеличено на указанное значение
                    </div>
                </form>
                <div id="updateResult" class="alert d-none mt-3"></div>
            `;
            
            // Настраиваем обработчик формы
            setTimeout(function() {
                var form = document.getElementById('quickUpdateForm');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        submitQuickUpdate(materialId);
                    });
                }
            }, 100);
        });
    }
}

// Отправка быстрого обновления
function submitQuickUpdate(materialId) {
    var form = document.getElementById('quickUpdateForm');
    var formData = new FormData(form);
    var resultDiv = document.getElementById('updateResult');
    
    fetch(`/materials/${materialId}/update-quantity/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle me-2"></i>
                    Количество успешно обновлено
                </div>
            `;
            
            // Обновляем страницу через 1 секунду
            setTimeout(function() {
                window.location.reload();
            }, 1000);
            
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${data.error || 'Ошибка при обновлении'}
                </div>
            `;
        }
        
        resultDiv.classList.remove('d-none');
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Ошибка сети
            </div>
        `;
        resultDiv.classList.remove('d-none');
    });
}
</script>
{% endblock %}